<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-2"><span class="text-3xl">ğŸ“Š</span> Analytics Dashboard</h1>
      <p class="text-slate-500 mt-1">Visual insights from your business data</p>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <!-- Quick Date Filters -->
      <div class="flex bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <button (click)="setDateRange(7)" class="px-3 py-2 text-sm font-medium hover:bg-indigo-50 hover:text-indigo-600 transition-colors">7D</button>
        <button (click)="setDateRange(30)" class="px-3 py-2 text-sm font-medium hover:bg-indigo-50 hover:text-indigo-600 transition-colors border-l">30D</button>
        <button (click)="setDateRange(90)" class="px-3 py-2 text-sm font-medium hover:bg-indigo-50 hover:text-indigo-600 transition-colors border-l">90D</button>
      </div>

      <!-- Date Range -->
      <div class="flex items-center gap-2 bg-white rounded-lg shadow-sm border border-slate-200 px-3 py-2">
        <input type="date" [(ngModel)]="fromDate" (change)="onDateChange()" class="text-sm border-none focus:ring-0 bg-transparent" />
        <span class="text-slate-400">to</span>
        <input type="date" [(ngModel)]="toDate" (change)="onDateChange()" class="text-sm border-none focus:ring-0 bg-transparent" />
      </div>

      <!-- Distributor Filter -->
      @if (distributors().length > 0) {
        <select
          [(ngModel)]="selectedDistributorId"
          (change)="onDistributorChange()"
          class="bg-white rounded-lg shadow-sm border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500"
        >
          <option [ngValue]="null">All Distributors</option>
          @for (dist of distributors(); track dist.id) {
            <option [ngValue]="dist.userId">{{ dist.businessName }}</option>
          }
        </select>
      }

      <!-- View Reports Button -->
      <button (click)="goToReports()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2">
        <span>ğŸ“‹</span> Detailed Reports
      </button>

      <!-- Download Dropdown -->
      <div class="relative">
        <button
          (click)="toggleDownloadMenu()"
          class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center gap-2"
        >
          <span>â¬‡ï¸</span> Download
        </button>
        @if (showDownloadMenu()) {
          <div class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-slate-200 z-50 overflow-hidden">
            <div class="py-1">
              <button (click)="downloadAllChartsAsPDF()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-indigo-50 flex items-center gap-2">
                <span>ğŸ“„</span> Download All Charts (PDF)
              </button>
              <button (click)="downloadAllChartsAsImages()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-indigo-50 flex items-center gap-2">
                <span>ğŸ–¼ï¸</span> Download All Charts (PNG)
              </button>
              <hr class="my-1 border-slate-200" />
              <button (click)="downloadDataAsExcel()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-green-50 flex items-center gap-2">
                <span>ğŸ“Š</span> Download Data (Excel)
              </button>
              <button (click)="downloadDataAsCSV()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-green-50 flex items-center gap-2">
                <span>ğŸ“‹</span> Download Data (CSV)
              </button>
              <hr class="my-1 border-slate-200" />
              <button (click)="downloadFullReport()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-purple-50 flex items-center gap-2">
                <span>ğŸ“‘</span> Full Report (PDF + Data)
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  @if (loading()) {
    <div class="fixed inset-0 bg-white/50 backdrop-blur-sm z-50 flex items-center justify-center">
      <div class="bg-white rounded-xl shadow-xl p-6 flex items-center gap-4">
        <div class="animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent"></div>
        <span class="text-slate-600 font-medium">Loading analytics...</span>
      </div>
    </div>
  }

  <!-- KPI Cards -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ’°</span>
        <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">Sales</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ formatCurrency(kpiData().totalSales) }}</p>
      <p class="text-xs text-slate-500 mt-1">Total Revenue</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ“¦</span>
        <span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full">Orders</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ kpiData().totalOrders | number }}</p>
      <p class="text-xs text-slate-500 mt-1">Total Invoices</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ“ˆ</span>
        <span class="text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded-full">Avg</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ formatCurrency(kpiData().avgOrderValue) }}</p>
      <p class="text-xs text-slate-500 mt-1">Avg Order Value</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ·ï¸</span>
        <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-full">Items</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ topItems().length }}</p>
      <p class="text-xs text-slate-500 mt-1">Top Selling Items</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ—ºï¸</span>
        <span class="text-xs text-teal-600 bg-teal-50 px-2 py-1 rounded-full">Areas</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ areaSales().length }}</p>
      <p class="text-xs text-slate-500 mt-1">Active Regions</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <span class="text-2xl">ğŸ“‹</span>
        <span class="text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded-full">GST</span>
      </div>
      <p class="text-2xl font-bold text-slate-800 mt-2">{{ formatCurrency(gstAnalysis()?.summary?.totalGST || 0) }}</p>
      <p class="text-xs text-slate-500 mt-1">Total GST Collected</p>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Sales Trend Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ“ˆ</span> Sales Trend</h3>
        <span class="text-sm text-slate-500">Daily sales & invoice count</span>
      </div>
      <div class="h-80">
        <canvas #salesTrendChart></canvas>
      </div>
    </div>

    <!-- Category Distribution -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ·ï¸</span> Category Distribution</h3>
      </div>
      <div class="h-72">
        <canvas #categoryPieChart></canvas>
      </div>
    </div>

    <!-- Payment Status -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ’³</span> Payment Status</h3>
      </div>
      <div class="h-72">
        <canvas #paymentDonutChart></canvas>
      </div>
    </div>
  </div>

  <!-- Second Row Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Items -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>â­</span> Top Selling Items</h3>
      </div>
      <div class="h-80">
        <canvas #topItemsChart></canvas>
      </div>
    </div>

    <!-- Distributor Performance -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸšš</span> Distributor Performance</h3>
      </div>
      <div class="h-80">
        <canvas #distributorBarChart></canvas>
      </div>
    </div>
  </div>

  <!-- India Map & Area Treemap Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- India Map - State-wise Sales -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ‡®ğŸ‡³</span> State-wise Sales (India Map)</h3>
        <span class="text-sm text-slate-500">Hover for details</span>
      </div>
      <div #indiaMap class="h-96 w-full relative"></div>
      @if (stateSales().length === 0) {
        <div class="absolute inset-0 flex items-center justify-center text-slate-400">
          <div class="text-center">
            <span class="text-4xl">ğŸ—ºï¸</span>
            <p class="mt-2">No state data available</p>
          </div>
        </div>
      }
    </div>

    <!-- Area Treemap -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ—ºï¸</span> Sales by Area (Treemap)</h3>
        <span class="text-sm text-slate-500">Click on areas for details</span>
      </div>
      <div #areaTreemap class="h-96 w-full"></div>
    </div>
  </div>

  <!-- Crop/Disease & Top Items Time Series Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Crop & Disease Sales -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸŒ¾</span> Crop & Disease Sales</h3>
        <div class="flex bg-slate-100 rounded-lg p-1">
          <button
            (click)="setCropDiseaseTab('crop')"
            [class]="cropDiseaseTab() === 'crop' ? 'bg-white shadow-sm text-green-600' : 'text-slate-600'"
            class="px-3 py-1 text-sm font-medium rounded-md transition-all"
          >
            ğŸŒ¾ Crop
          </button>
          <button
            (click)="setCropDiseaseTab('disease')"
            [class]="cropDiseaseTab() === 'disease' ? 'bg-white shadow-sm text-red-600' : 'text-slate-600'"
            class="px-3 py-1 text-sm font-medium rounded-md transition-all"
          >
            ğŸ¦  Disease
          </button>
        </div>
      </div>
      <div class="h-80">
        <canvas #cropDiseaseChart></canvas>
      </div>
      @if ((cropDiseaseTab() === 'crop' && cropSales().length === 0) || (cropDiseaseTab() === 'disease' && diseaseSales().length === 0)) {
        <div class="flex items-center justify-center h-80 text-slate-400">
          <div class="text-center">
            <span class="text-4xl">{{ cropDiseaseTab() === 'crop' ? 'ğŸŒ¾' : 'ğŸ¦ ' }}</span>
            <p class="mt-2">No {{ cropDiseaseTab() }} data available</p>
          </div>
        </div>
      }
    </div>

    <!-- Top 5 Items Time Series -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ“Š</span> Top 5 Items Trend</h3>
        <span class="text-sm text-slate-500">Quantity over time</span>
      </div>
      <div class="h-80">
        <canvas #topItemsTimeSeriesChart></canvas>
      </div>
    </div>
  </div>

  <!-- Quick Stats Tables -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Items Table -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 bg-gradient-to-r from-indigo-50 to-white">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ“¦</span> Top 5 Items by Quantity</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">#</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Item</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Qty</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Amount</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            @for (item of topItems().slice(0, 5); track item.itemId; let i = $index) {
              <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-4 py-3 text-sm text-slate-500">{{ i + 1 }}</td>
                <td class="px-4 py-3 text-sm font-medium text-slate-800">{{ item.itemName }}</td>
                <td class="px-4 py-3 text-sm text-right text-slate-600">{{ item.totalQuantitySold | number: '1.0-0' }}</td>
                <td class="px-4 py-3 text-sm text-right font-semibold text-green-600">{{ formatCurrency(item.totalSalesAmount) }}</td>
              </tr>
            }
            @if (topItems().length === 0) {
              <tr>
                <td colspan="4" class="px-4 py-8 text-center text-slate-400">No data available</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Areas Table -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 bg-gradient-to-r from-teal-50 to-white">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><span>ğŸ—ºï¸</span> Top 5 Areas by Sales</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">#</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Area</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Invoices</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Amount</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            @for (area of areaSales().slice(0, 5); track area.area; let i = $index) {
              <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-4 py-3 text-sm text-slate-500">{{ i + 1 }}</td>
                <td class="px-4 py-3 text-sm font-medium text-slate-800">{{ area.area || area.city || 'Unknown' }}</td>
                <td class="px-4 py-3 text-sm text-right text-slate-600">{{ area.totalInvoices | number }}</td>
                <td class="px-4 py-3 text-sm text-right font-semibold text-green-600">{{ formatCurrency(area.totalSalesAmount) }}</td>
              </tr>
            }
            @if (areaSales().length === 0) {
              <tr>
                <td colspan="4" class="px-4 py-8 text-center text-slate-400">No data available</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
