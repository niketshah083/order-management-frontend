<div class="min-h-screen bg-indigo-50">
  <!-- PROFESSIONAL HEADER SECTION -->
  <div class="bg-white border-b-4 border-indigo-600 shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-4">
      <!-- Title Row -->
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            @if (isEditMode()) {
              ‚úèÔ∏è Edit Invoice
            } @else {
              üí≥ Create Billing
            }
          </h1>
          <p class="text-sm text-gray-600 mt-1">
            @if (isEditMode()) {
              Edit draft invoice details
            } @else {
              Quick entry with batch tracking
            }
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-600">Total Amount</div>
          <div class="text-4xl font-bold text-indigo-600">‚Çπ{{ finalAmount().toFixed(0) }}</div>
          <div class="text-xs text-gray-500 mt-1">{{ billingItems().length }} items</div>
        </div>
      </div>

      <!-- Form Row -->
      <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-3">
        <!-- Date Field -->
        <div [formGroup]="billingForm">
          <label class="block text-xs font-bold text-gray-700 mb-1">üìÖ Bill Date *</label>
          <input
            type="date"
            formControlName="billDate"
            class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-semibold"
          />
        </div>

        <!-- Payment Type - Radio Buttons -->
        <div>
          <label class="block text-xs font-bold text-gray-700 mb-1">üí≥ Payment Type</label>
          <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
            <label class="flex-1">
              <input type="radio" name="paymentType" value="cash" [checked]="paymentType() === 'cash'" (change)="paymentType.set('cash')" class="sr-only peer" />
              <div class="px-2 py-2 text-center text-xs font-bold rounded-md cursor-pointer transition-all peer-checked:bg-green-500 peer-checked:text-white peer-checked:shadow-md bg-white text-gray-600 hover:bg-gray-50">
                üí∞ Cash
              </div>
            </label>
            <label class="flex-1">
              <input type="radio" name="paymentType" value="credit" [checked]="paymentType() === 'credit'" (change)="paymentType.set('credit')" class="sr-only peer" />
              <div class="px-2 py-2 text-center text-xs font-bold rounded-md cursor-pointer transition-all peer-checked:bg-orange-500 peer-checked:text-white peer-checked:shadow-md bg-white text-gray-600 hover:bg-gray-50">
                üìã Credit
              </div>
            </label>
            <label class="flex-1">
              <input type="radio" name="paymentType" value="online" [checked]="paymentType() === 'online'" (change)="paymentType.set('online')" class="sr-only peer" />
              <div class="px-2 py-2 text-center text-xs font-bold rounded-md cursor-pointer transition-all peer-checked:bg-blue-500 peer-checked:text-white peer-checked:shadow-md bg-white text-gray-600 hover:bg-gray-50">
                üîó Online
              </div>
            </label>
          </div>
        </div>

        <!-- Distributor (Admin only) -->
        @if (isAdmin()) {
        <div [formGroup]="billingForm">
          <label class="block text-xs font-bold text-gray-700 mb-1">üë• Distributor</label>
          <select
            formControlName="distributorId"
            class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-semibold bg-white"
          >
            <option [value]="null">Select...</option>
            @for (dist of distributors(); track dist.id) {
            <option [value]="dist.id">{{ dist.firstname }}</option>
            }
          </select>
        </div>
        }

        <!-- Customer Selection -->
        <div [ngClass]="isAdmin() ? '' : 'md:col-span-2'">
          <label class="block text-xs font-bold text-gray-700 mb-1">üë§ Customer *</label>
          @if (selectedCustomer()) {
          <div class="flex items-center gap-2">
            <div class="flex-1 px-3 py-2 bg-indigo-50 border-2 border-indigo-400 rounded-lg text-indigo-900 font-bold text-sm truncate">
              {{ selectedCustomer()!.firstname }} {{ selectedCustomer()!.lastname }}
            </div>
            <button
              type="button"
              (click)="selectedCustomer.set(null)"
              class="px-2 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-bold transition-colors"
              title="Change"
            >
              ‚úï
            </button>
          </div>
          } @else {
          <button
            type="button"
            (click)="openCustomerSearch()"
            class="w-full px-3 py-2 border-2 border-dashed border-indigo-400 rounded-lg hover:border-indigo-600 hover:bg-indigo-50 text-indigo-600 font-bold text-sm transition-colors"
          >
            + Select Customer
          </button>
          }
        </div>

        <!-- Quick Action Button -->
        <div class="flex items-end">
          <button
            type="button"
            (click)="openItemModal()"
            class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-bold text-sm shadow-md transition-all"
          >
            ‚ûï Add Items
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="max-w-7xl mx-auto px-4 md:px-6 pt-6">
    @if (successMessage()) {
    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-800 text-sm font-bold">
      ‚úÖ {{ successMessage() }}
    </div>
    }

    @if (errorMessage()) {
    <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm font-bold">
      ‚ùå {{ errorMessage() }}
    </div>
    }
  </div>

  <div class="max-w-7xl mx-auto px-4 md:px-6 py-6 space-y-4">
    <form [formGroup]="billingForm" class="space-y-4">

      <!-- COMPACT CROP/DISCOUNT/SUMMARY ROW -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Crop Details (Compact) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <h3 class="text-sm font-bold text-gray-900 mb-2">üåæ Crop Info</h3>
          <select
            formControlName="cropName"
            class="w-full px-3 py-2 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white mb-2 font-semibold"
          >
            <option value="">Select crop...</option>
            @for (crop of cropNames(); track crop) {
            <option [value]="crop">{{ crop }}</option>
            }
          </select>
          <select
            formControlName="cropDiseases"
            class="w-full px-3 py-2 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-semibold"
          >
            <option value="">Disease...</option>
            @for (disease of cornDiseases(); track disease) {
            <option [value]="disease">{{ disease }}</option>
            }
          </select>
        </div>

        <!-- Overall Discount (Compact) - Reactive -->
        <div class="bg-orange-50 rounded-lg shadow-sm border border-orange-200 p-4">
          <h3 class="text-sm font-bold text-orange-900 mb-2">üè∑Ô∏è Discount</h3>
          <div class="flex gap-2 mb-2">
            <input
              type="number"
              formControlName="overallDiscount"
              min="0"
              (input)="onDiscountChange($event)"
              class="flex-1 px-3 py-2 text-xs border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 text-right font-semibold"
              placeholder="0"
            />
            <div class="flex bg-white rounded-lg border border-orange-300 overflow-hidden">
              <button type="button" (click)="setDiscountType('percentage')" [class.bg-orange-500]="overallDiscountType() === 'percentage'" [class.text-white]="overallDiscountType() === 'percentage'" class="px-3 py-2 text-xs font-bold transition-colors">%</button>
              <button type="button" (click)="setDiscountType('amount')" [class.bg-orange-500]="overallDiscountType() === 'amount'" [class.text-white]="overallDiscountType() === 'amount'" class="px-3 py-2 text-xs font-bold transition-colors">‚Çπ</button>
            </div>
          </div>
          @if (overallDiscountValue() > 0 && subtotal() > 0) {
            <div class="text-xs text-orange-700 font-medium">
              Discount: ‚Çπ{{ calculateDiscountAmount().toFixed(2) }} 
              @if (overallDiscountType() === 'percentage') {
                ({{ overallDiscountValue() }}% of ‚Çπ{{ subtotal().toFixed(2) }})
              }
            </div>
          }
        </div>

        <!-- Billing Summary (Compact) -->
        @if (billingItems().length > 0) {
        <div class="bg-indigo-50 rounded-lg shadow-sm border border-indigo-200 p-4">
          <h3 class="text-sm font-bold text-indigo-900 mb-2">üìä Summary</h3>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between"><span>Subtotal:</span> <span class="font-bold">‚Çπ{{ subtotal().toFixed(0) }}</span></div>
            <div class="flex justify-between"><span>Tax:</span> <span class="font-bold text-blue-600">‚Çπ{{ (cgstTotal() + sgstTotal() + igstTotal()).toFixed(0) }}</span></div>
            <div class="border-t border-indigo-300 pt-1 mt-1 flex justify-between"><span class="font-bold">Final:</span> <span class="font-bold text-lg text-indigo-600">‚Çπ{{ finalAmount().toFixed(0) }}</span></div>
          </div>
        </div>
        }
      </div>

      <!-- ITEM GRID (FULL WIDTH) -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold text-gray-900">üì¶ Items ({{ billingItems().length }})</h2>
            @if (billingItems().length > 0) {
            <p class="text-xs text-gray-600">Total: ‚Çπ{{ getTotalBillingAmount() }}</p>
            }
          </div>
        </div>

        @if (billingItems().length > 0) {
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead class="bg-gray-100 border-b border-gray-300">
              <tr>
                <th class="px-3 py-2 text-left font-bold text-gray-700">Item</th>
                <th class="px-3 py-2 text-center font-bold text-gray-700">Batch/Serial</th>
                <th class="px-3 py-2 text-center font-bold text-gray-700">Expiry</th>
                <th class="px-3 py-2 text-right font-bold text-gray-700">Qty</th>
                <th class="px-3 py-2 text-right font-bold text-gray-700">Rate</th>
                <th class="px-3 py-2 text-right font-bold text-gray-700">Disc</th>
                <th class="px-3 py-2 text-right font-bold text-gray-700">GST</th>
                <th class="px-3 py-2 text-right font-bold text-gray-700">Total</th>
                <th class="px-3 py-2 text-center font-bold text-gray-700">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (item of billingItems(); track $index) {
              <tr [ngClass]="item.expiryStatus === 'expired' ? 'bg-red-50' : item.expiryStatus === 'expiring_soon' ? 'bg-yellow-50' : 'hover:bg-gray-50'">
                <td class="px-3 py-2 font-semibold text-gray-900">{{ item.itemName }}</td>
                <td class="px-3 py-2 text-center text-xs text-gray-700">
                  @if (item.batchNumber || item.serialNumber) {
                  <div class="font-mono text-xs bg-gray-100 px-2 py-1 rounded inline-block">
                    @if (item.batchNumber) { B:{{ item.batchNumber }} }
                    @if (item.serialNumber) { S:{{ item.serialNumber }} }
                  </div>
                  } @else if (item.inventoryId) {
                  <div class="font-mono text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded inline-block">
                    #{{ item.inventoryId }}
                  </div>
                  } @else {
                  <span class="text-gray-400">‚Äî</span>
                  }
                </td>
                <td class="px-3 py-2 text-center">
                  @if (item.expiryStatus) {
                  <span [class]="'px-2 py-1 rounded text-xs font-bold border ' + getExpiryStatusColor(item.expiryStatus)">
                    {{ getExpiryStatusBadge(item.expiryStatus) }}
                  </span>
                  } @else {
                  <span class="text-gray-400">‚Äî</span>
                  }
                </td>
                <td class="px-3 py-2 text-right">
                  <input
                    type="number"
                    [value]="item.quantity"
                    (input)="updateItemQuantity($index, $event)"
                    min="0.01"
                    step="0.01"
                    class="w-20 px-2 py-1 border border-blue-300 rounded text-right font-semibold text-sm focus:ring-2 focus:ring-blue-500"
                  />
                </td>
                <td class="px-3 py-2 text-right">
                  <div class="flex items-center gap-1 justify-end">
                    <input
                      type="number"
                      [value]="item.rate"
                      (input)="updateItemRate($index, $event)"
                      min="0"
                      step="0.01"
                      class="w-20 px-2 py-1 border border-blue-300 rounded text-right font-semibold text-sm focus:ring-2 focus:ring-blue-500"
                    />
                    <span class="text-xs text-gray-500">‚Çπ</span>
                  </div>
                </td>
                <td class="px-3 py-2 text-right">
                  <div class="flex items-center gap-1 justify-end">
                    <input
                      type="number"
                      [value]="item.discount"
                      (input)="updateItemDiscount($index, $event)"
                      min="0"
                      step="0.01"
                      class="w-16 px-2 py-1 border border-blue-300 rounded text-right font-semibold text-sm focus:ring-2 focus:ring-blue-500"
                    />
                    <span class="text-xs text-gray-500">{{ item.discountType === 'percentage' ? '%' : '‚Çπ' }}</span>
                  </div>
                </td>
                <td class="px-3 py-2 text-right text-gray-600">‚Çπ{{ (item.cgst + item.sgst + item.igst).toFixed(2) }}</td>
                <td class="px-3 py-2 text-right font-bold text-indigo-600">‚Çπ{{ item.totalAmount.toFixed(2) }}</td>
                <td class="px-3 py-2 text-center">
                  <button
                    type="button"
                    (click)="removeItem($index)"
                    class="text-red-600 hover:text-red-800 font-bold transition-colors"
                    title="Remove"
                  >
                    ‚úï
                  </button>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        } @else {
        <div class="text-center py-10 border-2 border-dashed border-gray-300 rounded-lg">
          <p class="text-gray-500 font-medium text-sm">No items added yet. Click "+ Add Item" to get started.</p>
        </div>
        }
      </div>

      <!-- NOTES & BUTTONS (COMPACT) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Notes -->
        <div class="md:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">üìù Notes</label>
          <textarea
            formControlName="notes"
            rows="2"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all text-sm"
            placeholder="Add any notes or remarks..."
          ></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col gap-2">
          <button
            type="button"
            (click)="saveDraft()"
            [disabled]="isLoading() || billingForm.invalid || !selectedCustomer() || billingItems().length === 0"
            class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white rounded-lg font-bold text-sm shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {{ isLoading() ? '‚è≥ Saving...' : 'üíæ Save Draft' }}
          </button>
          <button
            type="button"
            (click)="completeBilling()"
            [disabled]="isLoading() || billingForm.invalid || !selectedCustomer() || billingItems().length === 0"
            class="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-bold text-sm shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {{ isLoading() ? '‚è≥ Completing...' : '‚úÖ Complete Invoice' }}
          </button>
          <button
            type="button"
            (click)="resetBillingForm()"
            class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-bold text-sm transition-colors"
          >
            üîÑ Reset
          </button>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- Customer Search Modal -->
<app-modal [isOpen]="showCustomerSearch()" (close)="showCustomerSearch.set(false)" title="Select Customer">
  <div class="p-4 space-y-3">
    <input
      type="text"
      [(ngModel)]="customerSearchQuery"
      [ngModelOptions]="{standalone: true}"
      placeholder="Search by name, mobile, or email..."
      class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
    />

    <button
      type="button"
      (click)="openNewCustomerForm()"
      class="w-full px-3 py-2 text-sm border-2 border-dashed border-indigo-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all text-indigo-600 font-bold"
    >
      + Add New Customer
    </button>

    <div class="max-h-80 overflow-y-auto space-y-1">
      @for (customer of filteredCustomers(); track customer.id) {
      <div
        (click)="selectCustomer(customer)"
        class="p-2 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all text-sm"
      >
        <div class="font-semibold text-gray-900">
          {{ customer.firstname }} {{ customer.lastname }}
        </div>
        <div class="text-xs text-gray-600">{{ customer.mobileNo }}</div>
      </div>
      } @empty {
      <div class="text-center py-6 text-xs text-gray-500">
        No customers found. Click "Add New Customer" to create one.
      </div>
      }
    </div>
  </div>
</app-modal>

<!-- New Customer Modal - Unified Form -->
<app-modal [isOpen]="showCustomerModal()" (close)="closeCustomerModal()" title="Add New Customer">
  <div class="p-4">
    <app-add-customer-form
      [isEditing]="false"
      (submitted)="onCustomerFormSubmitted($event)"
      (cancelled)="closeCustomerModal()"
    ></app-add-customer-form>
  </div>
</app-modal>

<!-- Batch/Serial Bulk Input Modal -->
<app-batch-serial-input></app-batch-serial-input>

<!-- Add Item Modal - Dual Search Design -->
<app-modal [isOpen]="showItemModal()" (close)="closeItemModal()" [title]="showBatchPicker() ? 'üì¶ Select Batch & Quantity' : '‚ûï Add Item'">
  <div class="p-6 max-w-2xl space-y-4">
    <!-- BATCH PICKER VIEW (Inside same modal) -->
    @if (showBatchPicker() && batchOptionsForSelector().length > 0) {
    <div class="space-y-4">
      <p class="text-sm text-gray-600 font-medium">{{ selectedItemForBatch()?.name }} - Select batch and quantity</p>
      
      <!-- Warning for items with serial tracking -->
      @if (selectedItemForBatch()?.hasSerialTracking) {
        <div class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
          ‚ö†Ô∏è This item has <strong>serial tracking</strong> enabled. You must select an entry with a serial number (S: xxx).
        </div>
      }
      
      <!-- Available Batches Table -->
      <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
        <table class="w-full text-sm">
          <thead class="bg-blue-100 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Batch/Serial</th>
              <th class="px-3 py-2 text-left font-semibold">Qty</th>
              <th class="px-3 py-2 text-left font-semibold">Expiry</th>
              <th class="px-3 py-2 text-center font-semibold">Action</th>
            </tr>
          </thead>
          <tbody>
            @for (batch of batchOptionsForSelector(); track batch.id) {
              <tr class="border-t hover:bg-blue-50" [class.opacity-50]="selectedItemForBatch()?.hasSerialTracking && !batch.serialNumber">
                <td class="px-3 py-2 font-mono font-semibold">
                  @if (batch.serialNumber) {
                    <span class="text-purple-600">S: {{ batch.serialNumber }}</span>
                    @if (batch.batchNumber) {
                      <span class="text-gray-400 text-xs ml-1">(B: {{ batch.batchNumber }})</span>
                    }
                  } @else if (batch.batchNumber) {
                    <span class="text-blue-600">B: {{ batch.batchNumber }}</span>
                    @if (selectedItemForBatch()?.hasSerialTracking) {
                      <span class="text-red-500 text-xs ml-1">‚ö†Ô∏è No serial</span>
                    }
                  } @else {
                    <span class="text-gray-400 italic">Stock #{{ batch.id }}</span>
                  }
                </td>
                <td class="px-3 py-2 font-medium">{{ batch.quantity }}</td>
                <td class="px-3 py-2 text-xs">
                  @if (batch.expiryDate) {
                    <div>{{ batch.expiryDate }}</div>
                    @switch (batch.expiryStatus) {
                      @case ('expired') {
                        <span class="bg-red-100 text-red-800 px-1 py-0.5 rounded text-xs">üî¥ Expired</span>
                      }
                      @case ('expiring_soon') {
                        <span class="bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded text-xs">üü° Soon</span>
                      }
                      @case ('valid') {
                        <span class="bg-green-100 text-green-800 px-1 py-0.5 rounded text-xs">‚úÖ Valid</span>
                      }
                    }
                  } @else {
                    <span class="text-gray-400">No expiry</span>
                  }
                </td>
                <td class="px-3 py-2 text-center">
                  @if (selectedItemForBatch()?.hasSerialTracking && !batch.serialNumber) {
                    <span class="text-xs text-gray-400">N/A</span>
                  } @else {
                    <button type="button" (click)="selectedBatchForPicker.set(batch)" [class.bg-blue-200]="selectedBatchForPicker()?.id === batch.id" class="px-2 py-1 text-blue-600 hover:text-blue-800 font-semibold rounded hover:bg-blue-100 transition">Select</button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Quantity Selector -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 space-y-3">
        <div class="flex items-center gap-4">
          <div class="flex-1">
            <label class="text-sm font-semibold text-gray-700 block mb-1">Enter Quantity:</label>
            <input 
              type="number" 
              [(ngModel)]="selectedQtyForBatchInput"
              [ngModelOptions]="{standalone: true}"
              min="1"
              class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-bold"
              (change)="updateQtyFromInput(selectedQtyForBatchInput)"
            />
          </div>
          <div class="text-center">
            <div class="text-xs text-gray-600 mb-1">Current Qty:</div>
            <span class="text-3xl font-bold text-blue-600">{{ selectedQtyForBatch() }}</span>
          </div>
        </div>
        
        <div class="grid grid-cols-5 gap-2">
          <button type="button" (click)="decrementQty(10)" class="px-2 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded font-bold text-sm">-10</button>
          <button type="button" (click)="decrementQty(5)" class="px-2 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded font-bold text-sm">-5</button>
          <button type="button" (click)="decrementQty(1)" class="px-2 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded font-bold text-sm">-1</button>
          <button type="button" (click)="incrementQty(1)" class="px-2 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded font-bold text-sm">+1</button>
          <button type="button" (click)="incrementQty(5)" class="px-2 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded font-bold text-sm">+5</button>
        </div>
      </div>
      
      <div class="flex gap-2 pt-4 border-t">
        <button type="button" (click)="closeBatchPicker()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium">‚Üê Back</button>
        <button type="button" (click)="selectBatchFromPicker(selectedBatchForPicker() || batchOptionsForSelector()[0])" [disabled]="!selectedBatchForPicker() && batchOptionsForSelector().length === 0" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-medium">‚úì Add to Billing</button>
      </div>
    </div>
    } @else {
    <form [formGroup]="itemAddForm" class="space-y-4">
      
      <!-- UNIFIED SEARCH BOX -->
      <div>
        <label class="block text-sm font-bold text-gray-900 mb-2">üîç Search Item (Name, Batch, or Serial)</label>
        
        <!-- Single Search Input with Barcode Scanner -->
        <div class="flex gap-2 mb-3">
          <div class="flex-1 relative">
            <input
              type="text"
              [(ngModel)]="unifiedSearchQuery"
              [ngModelOptions]="{standalone: true}"
              placeholder="Type item name, batch number, or serial number..."
              (input)="onUnifiedSearch($event)"
              (keyup.enter)="performUnifiedSearch()"
              class="w-full px-4 py-3 text-sm border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 pr-10"
            />
            @if (isSearching()) {
              <div class="absolute right-3 top-1/2 -translate-y-1/2">
                <div class="animate-spin h-5 w-5 border-2 border-indigo-500 border-t-transparent rounded-full"></div>
              </div>
            }
          </div>
          <app-barcode-scanner (scanned)="onBarcodeScanned($event)"></app-barcode-scanner>
        </div>

        <!-- Search Mode Indicator -->
        <div class="flex gap-2 mb-3 text-xs">
          <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-medium">üì¶ Items</span>
          <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full font-medium">üè∑Ô∏è Batches</span>
          <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium">üî¢ Serials</span>
        </div>

        <!-- UNIFIED SEARCH RESULTS -->
        @if (unifiedSearchQuery.length >= 2) {
          <!-- Items by Name -->
          @if (filteredItems().length > 0) {
            <div class="mb-3">
              <div class="text-xs font-bold text-gray-600 mb-1 px-1">üì¶ ITEMS BY NAME</div>
              <div class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                @for (item of filteredItems(); track item.id) {
                  <div
                    (click)="onItemSelect(item)"
                    [class.opacity-50]="!(itemStockStatus().get(item.id)?.inStock)"
                    [class.cursor-not-allowed]="!(itemStockStatus().get(item.id)?.inStock)"
                    [class.cursor-pointer]="itemStockStatus().get(item.id)?.inStock"
                    class="p-2 border-b border-gray-100 hover:bg-indigo-100 transition-colors text-sm flex justify-between items-center"
                  >
                    <div>
                      <div class="font-bold text-gray-900">{{ item.name }}</div>
                      <div class="text-xs text-gray-600">‚Çπ{{ item.rate }}/{{ item.unit }}</div>
                    </div>
                    <div>
                      @if (itemStockStatus().get(item.id)?.inStock) {
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded">‚úÖ In Stock</span>
                      } @else {
                        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded">‚ùå Out</span>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Items by Batch/Serial -->
          @if (itemsFoundByBatch().length > 0) {
            <div class="space-y-2 bg-purple-50 border border-purple-200 rounded-lg p-3">
              <div class="text-xs font-bold text-purple-900">üè∑Ô∏è BATCH/SERIAL MATCHES ({{ itemsFoundByBatch().length }})</div>
              <div class="max-h-64 overflow-y-auto border border-purple-300 rounded-lg bg-white">
              @for (itemResult of itemsFoundByBatch(); track itemResult.id) {
              <div class="border-b border-purple-100 p-3 hover:bg-purple-50">
                <div class="font-bold text-gray-900 mb-2">üì¶ {{ itemResult.name }} - ‚Çπ{{ itemResult.rate }}/{{ itemResult.unit }}</div>
                <!-- Show hint if item has both batch and serial tracking -->
                @if (itemResult.hasBatchTracking && itemResult.hasSerialTracking) {
                <div class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 mb-2">
                  ‚ö†Ô∏è This item has serial tracking. Click on a <strong>serial entry</strong> (S: ...) to add to invoice.
                </div>
                }
                <div class="space-y-1">
                  @for (batch of itemResult.batches; track batch.inventoryId) {
                  <!-- Different styling for batch-only vs serial entries -->
                  @if (batch.serialNumber) {
                  <!-- SERIAL ENTRY - Always clickable -->
                  <button
                    type="button"
                    (click)="selectItemFromBatchSearch(itemResult, batch)"
                    class="w-full text-left p-2 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded border-2 border-blue-300 text-xs transition-colors cursor-pointer"
                  >
                    <div class="flex justify-between items-start">
                      <div>
                        @if (batch.linkedBatchNumber || batch.batchNumber) {
                        <span class="font-mono text-purple-700">B: {{ batch.linkedBatchNumber || batch.batchNumber }}</span>
                        <span class="mx-1">‚Üí</span>
                        }
                        <span class="font-mono font-bold text-blue-900 bg-blue-200 px-1 rounded">S: {{ batch.serialNumber }}</span>
                      </div>
                      <div class="text-right">
                        <div class="font-bold text-blue-700">Qty: {{ batch.quantity }}</div>
                        @if (batch.expiryDate) {
                        <div [class]="
                          batch.expiryStatus === 'expired' ? 'text-red-700 font-bold' :
                          batch.expiryStatus === 'expiring_soon' ? 'text-orange-700 font-bold' :
                          batch.expiryStatus === 'valid' ? 'text-green-700 font-bold' :
                          'text-gray-600'
                        ">
                          @if (batch.expiryStatus === 'expired') { üî¥ }
                          @else if (batch.expiryStatus === 'expiring_soon') { üü° }
                          @else if (batch.expiryStatus === 'valid') { ‚úÖ }
                          {{ batch.expiryDate | date: 'dd-MMM-yyyy' }}
                        </div>
                        }
                      </div>
                    </div>
                  </button>
                  } @else {
                  <!-- BATCH-ONLY ENTRY - Disabled if item has serial tracking -->
                  <button
                    type="button"
                    (click)="selectItemFromBatchSearch(itemResult, batch)"
                    [disabled]="itemResult.hasSerialTracking"
                    [class]="itemResult.hasSerialTracking 
                      ? 'w-full text-left p-2 bg-gray-100 rounded border border-gray-300 text-xs opacity-60 cursor-not-allowed'
                      : 'w-full text-left p-2 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded border border-purple-200 text-xs transition-colors cursor-pointer'"
                  >
                    <div class="flex justify-between items-start">
                      <div>
                        <span class="font-mono font-bold text-purple-900">B: {{ batch.batchNumber }}</span>
                        @if (itemResult.hasSerialTracking) {
                        <span class="ml-2 text-gray-500 text-xs">(select serial below ‚Üì)</span>
                        }
                      </div>
                      <div class="text-right">
                        <div class="font-bold text-blue-700">Qty: {{ batch.quantity }}</div>
                        @if (batch.expiryDate) {
                        <div [class]="
                          batch.expiryStatus === 'expired' ? 'text-red-700 font-bold' :
                          batch.expiryStatus === 'expiring_soon' ? 'text-orange-700 font-bold' :
                          batch.expiryStatus === 'valid' ? 'text-green-700 font-bold' :
                          'text-gray-600'
                        ">
                          @if (batch.expiryStatus === 'expired') { üî¥ }
                          @else if (batch.expiryStatus === 'expiring_soon') { üü° }
                          @else if (batch.expiryStatus === 'valid') { ‚úÖ }
                          {{ batch.expiryDate | date: 'dd-MMM-yyyy' }}
                        </div>
                        }
                      </div>
                    </div>
                  </button>
                  }
                  }
                </div>
              </div>
              }
              </div>
            </div>
          }
          
          <!-- No results message -->
          @if (filteredItems().length === 0 && itemsFoundByBatch().length === 0 && !isSearching()) {
            <div class="text-center py-4 text-gray-500 text-sm bg-gray-50 rounded border border-gray-200">
              üîç No items found for "{{ unifiedSearchQuery }}"
            </div>
          }
        }
      </div>

      <!-- Quantity & Rate -->
      @if (itemAddForm.get('selectedItem')?.value) {
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-bold text-gray-900 mb-1">Quantity *</label>
          <input type="number" formControlName="quantity" min="0.01" step="0.01" class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-900 mb-1">Rate (‚Çπ) *</label>
          <input type="number" formControlName="rate" min="0" step="0.01" class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
        </div>
      </div>

      <!-- Box Ordering Option -->
      @if (selectedItemForBatch()?.hasBoxPackaging) {
      <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3">
        <div class="flex items-center gap-3 mb-3">
          <input 
            type="checkbox" 
            formControlName="orderedByBox"
            id="orderedByBox"
            class="w-4 h-4 rounded"
          />
          <label for="orderedByBox" class="text-sm font-bold text-blue-900">üì¶ Order by Box</label>
          <span class="text-xs text-blue-700">{{ selectedItemForBatch()?.unitsPerBox }} units/box @ ‚Çπ{{ selectedItemForBatch()?.boxRate }}/box</span>
        </div>
        @if (itemAddForm.get('orderedByBox')?.value) {
        <div>
          <label class="block text-xs font-bold text-blue-900 mb-1">Number of Boxes *</label>
          <input 
            type="number" 
            formControlName="boxCount" 
            min="1" 
            step="1"
            class="w-full px-3 py-2 text-sm border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="How many boxes?"
          />
          @if (itemAddForm.get('boxCount')?.value) {
          <div class="mt-2 text-xs text-blue-700 font-semibold">
            üìä {{ (itemAddForm.get('boxCount')?.value || 0) * (selectedItemForBatch()?.unitsPerBox || 1) }} units = ‚Çπ{{ ((itemAddForm.get('boxCount')?.value || 0) * (selectedItemForBatch()?.boxRate || 0)).toFixed(2) }}
          </div>
          }
        </div>
        }
      </div>
      }

      <!-- Discount -->
      <div>
        <label class="block text-sm font-bold text-gray-900 mb-1">Discount (Optional)</label>
        <div class="flex gap-2">
          <input type="number" formControlName="discount" min="0" step="0.01" placeholder="Amount" class="flex-1 px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
          <select formControlName="discountType" class="w-14 px-2 py-2 text-sm border-2 border-gray-300 rounded-lg bg-white font-bold">
            <option value="percentage">%</option>
            <option value="amount">‚Çπ</option>
          </select>
        </div>
      </div>

      <!-- Batch/Serial/Expiry - Powerful Selector -->
      @if (selectedItemForBatch()?.hasBatchTracking || selectedItemForBatch()?.hasSerialTracking || selectedItemForBatch()?.hasExpiryDate) {
      <div>
        <label class="block text-xs font-bold text-amber-900 mb-2">üéØ Select Batch/Serial with Available Quantity</label>
        <app-batch-selector
          [batches]="batchOptionsForSelector()"
          #batchSelector
        ></app-batch-selector>
        <!-- Hidden inputs to sync selected batch to form -->
        <div class="hidden">
          <input 
            type="hidden" 
            formControlName="batchNumber"
            [value]="batchSelector?.getSelectedValue()?.batchNumber || ''"
          />
          <input 
            type="hidden" 
            formControlName="serialNumber"
            [value]="batchSelector?.getSelectedValue()?.serialNumber || ''"
          />
          <input 
            type="hidden" 
            formControlName="expiryDate"
            [value]="batchSelector?.getSelectedValue()?.expiryDate || ''"
          />
        </div>
      </div>
      }
      }

      <!-- Buttons -->
      <div class="flex gap-3 pt-4">
        <button 
          type="button" 
          (click)="addItemToBilling()"
          [disabled]="itemAddForm.invalid || !itemAddForm.get('selectedItem')?.value"
          class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ‚úÖ Add Item
        </button>
        <button 
          type="button" 
          (click)="closeItemModal()"
          class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm transition-colors"
        >
          Done
        </button>
      </div>
    </form>
    }

    <!-- Items Count -->
    @if (billingItems().length > 0) {
    <div class="border-t border-gray-200 pt-3 text-sm">
      <div class="text-gray-600">Items added: <span class="font-bold text-indigo-600">{{ billingItems().length }}</span></div>
      <div class="text-gray-600">Total: <span class="font-bold text-indigo-600">‚Çπ{{ getTotalBillingAmount() }}</span></div>
    </div>
    }
  </div>
</app-modal>
